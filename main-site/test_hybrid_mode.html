<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Modo H√≠brido (MySQL + Gun.js)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold mb-2">üîÑ Test Modo H√≠brido</h1>
            <p class="text-gray-300">MySQL + Gun.js Synchronization</p>
        </header>

        <!-- Status -->
        <section class="bg-gray-800/50 backdrop-blur p-6 rounded-xl border border-gray-700 mb-8">
            <h2 class="text-2xl font-bold mb-4">üìä Estado del Sistema</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div id="mysql-status" class="p-4 bg-gray-700/50 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
                        <span class="font-semibold">MySQL</span>
                    </div>
                    <div class="text-sm text-gray-400">Verificando...</div>
                </div>
                <div id="gunjs-status" class="p-4 bg-gray-700/50 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
                        <span class="font-semibold">Gun.js</span>
                    </div>
                    <div class="text-sm text-gray-400">Verificando...</div>
                </div>
                <div id="hybrid-status" class="p-4 bg-gray-700/50 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
                        <span class="font-semibold">Hybrid Sync</span>
                    </div>
                    <div class="text-sm text-gray-400">Verificando...</div>
                </div>
            </div>
        </section>

        <!-- Mode Selector -->
        <section class="bg-gray-800/50 backdrop-blur p-6 rounded-xl border border-gray-700 mb-8">
            <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Modo de Operaci√≥n</h2>
            <div class="flex gap-4">
                <button onclick="setMode('centralized')" 
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-colors">
                    üîí Modo Centralizado (MySQL primero)
                </button>
                <button onclick="setMode('p2p')" 
                        class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-colors">
                    üåê Modo P2P (Gun.js primero)
                </button>
            </div>
            <div id="current-mode" class="mt-4 p-4 bg-gray-700/50 rounded-lg">
                <span class="font-semibold">Modo actual:</span> <span id="mode-text">No definido</span>
            </div>
        </section>

        <!-- Actions -->
        <section class="bg-gray-800/50 backdrop-blur p-6 rounded-xl border border-gray-700 mb-8">
            <h2 class="text-2xl font-bold mb-4">üöÄ Acciones</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-semibold mb-2">Crear Post H√≠brido</h3>
                    <textarea id="post-content" 
                              class="w-full p-3 bg-gray-700 rounded-lg text-white mb-2" 
                              rows="3" 
                              placeholder="Escribe tu post..."></textarea>
                    <button onclick="createHybridPost()" 
                            class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors">
                        üìù Crear Post H√≠brido
                    </button>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">Leer Posts</h3>
                    <button onclick="readPosts()" 
                            class="w-full px-4 py-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-semibold transition-colors mb-2">
                        üìñ Leer Posts (modo actual)
                    </button>
                    <button onclick="compareSources()" 
                            class="w-full px-4 py-3 bg-teal-600 hover:bg-teal-700 rounded-lg font-semibold transition-colors">
                        üîç Comparar MySQL vs Gun.js
                    </button>
                </div>
            </div>
        </section>

        <!-- Posts Display -->
        <section class="bg-gray-800/50 backdrop-blur p-6 rounded-xl border border-gray-700 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">üìã Posts</h2>
                <span id="post-count" class="text-gray-400">0 posts</span>
            </div>
            <div id="posts-container" class="space-y-3 max-h-96 overflow-y-auto">
                <div class="text-gray-500 text-center py-8">Crea o carga posts para verlos aqu√≠...</div>
            </div>
        </section>

        <!-- Logs -->
        <section class="bg-gray-800/50 backdrop-blur p-6 rounded-xl border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">üìä Logs</h2>
                <button onclick="clearLogs()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition-colors">
                    Limpiar
                </button>
            </div>
            <div id="logs" class="space-y-2 max-h-64 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">Esperando eventos...</div>
            </div>
        </section>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="assets/js/gun-client.js"></script>
    <script src="assets/js/hybrid-sync.js"></script>

    <script>
        // ============================================
        // UTILS
        // ============================================
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: 'text-green-400 border-green-500',
                error: 'text-red-400 border-red-500',
                info: 'text-blue-400 border-blue-500',
                warning: 'text-yellow-400 border-yellow-500'
            };
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: 'üìå',
                warning: '‚ö†Ô∏è'
            };

            const entry = document.createElement('div');
            entry.className = `${colors[type]} border-l-4 pl-4 py-2`;
            entry.textContent = `${icons[type]} [${timestamp}] ${message}`;
            
            if (logsDiv.querySelector('.text-gray-500')) {
                logsDiv.innerHTML = '';
            }
            
            logsDiv.insertBefore(entry, logsDiv.firstChild);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="text-gray-500">Esperando eventos...</div>';
        }

        function updateStatus(id, status, text) {
            const el = document.getElementById(id);
            const dot = el.querySelector('.w-3');
            const textEl = el.querySelector('.text-sm');
            
            dot.classList.remove('bg-yellow-500', 'bg-green-500', 'bg-red-500', 'animate-pulse');
            
            if (status === 'ok') {
                dot.classList.add('bg-green-500');
            } else if (status === 'error') {
                dot.classList.add('bg-red-500');
            } else {
                dot.classList.add('bg-yellow-500', 'animate-pulse');
            }
            
            textEl.textContent = text;
        }

        // ============================================
        // INIT
        // ============================================
        
        (async () => {
            log('Iniciando verificaciones...', 'info');
            
            // Check MySQL
            try {
                const canAccess = await hybridSync.checkMySQL();
                updateStatus('mysql-status', canAccess ? 'ok' : 'error', 
                            canAccess ? 'Disponible' : 'No disponible');
                log(`MySQL: ${canAccess ? 'OK' : 'NO DISPONIBLE'}`, canAccess ? 'success' : 'warning');
            } catch (error) {
                updateStatus('mysql-status', 'error', 'Error');
                log('MySQL: ERROR', 'error');
            }
            
            // Check Gun.js
            try {
                const success = await gunClient.init('http://localhost:8765/gun');
                updateStatus('gunjs-status', success ? 'ok' : 'error', 
                            success ? 'Conectado' : 'No conectado');
                log(`Gun.js: ${success ? 'CONECTADO' : 'NO CONECTADO'}`, success ? 'success' : 'warning');
            } catch (error) {
                updateStatus('gunjs-status', 'error', 'Error');
                log('Gun.js: ERROR', 'error');
            }
            
            // Init Hybrid Sync
            try {
                const success = await hybridSync.init();
                updateStatus('hybrid-status', success ? 'ok' : 'error', 
                            success ? 'Activo' : 'Inactivo');
                log(`Hybrid Sync: ${success ? 'ACTIVO' : 'INACTIVO'}`, success ? 'success' : 'warning');
            } catch (error) {
                updateStatus('hybrid-status', 'error', 'Error');
                log('Hybrid Sync: ERROR', 'error');
            }
            
            // Set initial mode
            const currentMode = localStorage.getItem('p2pMode') === 'true' ? 'p2p' : 'centralized';
            updateModeDisplay(currentMode);
        })();

        // ============================================
        // MODE MANAGEMENT
        // ============================================
        
        function setMode(mode) {
            localStorage.setItem('p2pMode', mode === 'p2p' ? 'true' : 'false');
            updateModeDisplay(mode);
            log(`Modo cambiado a: ${mode}`, 'success');
        }

        function updateModeDisplay(mode) {
            const text = mode === 'p2p' ? 'üåê P2P (Gun.js primero)' : 'üîí Centralizado (MySQL primero)';
            document.getElementById('mode-text').textContent = text;
        }

        // ============================================
        // ACTIONS
        // ============================================
        
        async function createHybridPost() {
            const content = document.getElementById('post-content').value.trim();
            
            if (!content) {
                log('El contenido no puede estar vac√≠o', 'warning');
                return;
            }
            
            log('Creando post h√≠brido...', 'info');
            
            try {
                const result = await hybridSync.createPost({
                    author: 'TestUser',
                    content: content
                });
                
                log(`Post creado exitosamente (${result.mode})`, 'success');
                log(`MySQL: ${result.sync.mysql ? '‚úÖ' : '‚ùå'} | Gun.js: ${result.sync.gunjs ? '‚úÖ' : '‚ùå'}`, 'info');
                
                document.getElementById('post-content').value = '';
                
                // Refresh posts
                setTimeout(() => readPosts(), 500);
            } catch (error) {
                log(`Error creando post: ${error.message}`, 'error');
            }
        }

        async function readPosts() {
            log('Leyendo posts...', 'info');
            
            try {
                const posts = await hybridSync.getPosts();
                displayPosts(posts);
                log(`${posts.length} posts obtenidos`, 'success');
            } catch (error) {
                log(`Error leyendo posts: ${error.message}`, 'error');
            }
        }

        function displayPosts(posts) {
            const container = document.getElementById('posts-container');
            document.getElementById('post-count').textContent = `${posts.length} posts`;
            
            if (posts.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-8">No hay posts</div>';
                return;
            }
            
            container.innerHTML = posts.map(post => `
                <div class="p-4 bg-gray-700/50 rounded-lg border border-gray-600">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-semibold">${post.author || post.username || 'An√≥nimo'}</span>
                        <span class="text-xs text-gray-400">${formatDate(post.timestamp || post.created_at)}</span>
                    </div>
                    <p class="text-gray-300">${post.content}</p>
                    <div class="mt-2 flex gap-4 text-xs text-gray-400">
                        <span>üí¨ ${post.comments || post.comments_count || 0}</span>
                        <span>‚ù§Ô∏è ${post.likes || post.likes_count || 0}</span>
                    </div>
                </div>
            `).join('');
        }

        async function compareSources() {
            log('Comparando MySQL vs Gun.js...', 'info');
            
            try {
                const mysqlPosts = await hybridSync.getPostsFromMySQL();
                const gunjsPosts = await hybridSync.getPostsFromGunJS();
                
                log(`MySQL: ${mysqlPosts.length} posts`, 'info');
                log(`Gun.js: ${gunjsPosts.length} posts`, 'info');
                
                const diff = Math.abs(mysqlPosts.length - gunjsPosts.length);
                if (diff === 0) {
                    log('‚úÖ Ambas fuentes tienen la misma cantidad de posts', 'success');
                } else {
                    log(`‚ö†Ô∏è Diferencia de ${diff} posts entre fuentes`, 'warning');
                }
            } catch (error) {
                log(`Error comparando fuentes: ${error.message}`, 'error');
            }
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            if (typeof date === 'number') {
                date = new Date(date);
            } else if (typeof date === 'string') {
                date = new Date(date);
            }
            return date.toLocaleString();
        }
    </script>
</body>
</html>
